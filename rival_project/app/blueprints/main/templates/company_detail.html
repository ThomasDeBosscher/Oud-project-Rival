{% extends 'base.html' %}

{% block title %}Rival.com — Company analysis{% endblock %}

{% block content %}
        <div class="container">
                        <div class="company-header">
                                <h1>{{ company.name }}</h1>
                                <p class="text-muted">
                                        {% if finance and finance.ticker %}
                                            <span class="ticker-chip">{{ finance.ticker }}</span>
                                        {% endif %}
                                        · Website: {% if company.url %}<a href="{{ company.url }}" target="_blank" rel="noopener">{{ company.url }}</a>{% else %}—{% endif %}
                                </p>
                                {% if finance and finance.price is not none %}
                                                <div class="price-line">
                                                        <div class="price-value">{% if finance.price is not none %}{{ '%.2f'|format(finance.price) }}{% else %}—{% endif %} {% if finance.currency %}{{ finance.currency }}{% endif %}</div>
                                                        {% set cp = finance.change_percent|default(none) %}
                                        {% if cp is not none %}
                                            {% set up = cp >= 0 %}
                                            <div class="chip {{ 'chip-up' if up else 'chip-down' }}">
                                                <span class="arrow">{{ '▲' if up else '▼' }}</span>
                                                <span>{{ '%.2f'|format(cp) }}%</span>
                                            </div>
                                        {% endif %}
                                        {% if finance.updated_at %}
                                            <span class="asof text-muted">as of {{ finance.updated_at.strftime('%Y-%m-%d %H:%M') }}</span>
                                        {% endif %}
                                </div>
                                {% endif %}
                        </div>

            <section class="company-info card" style="margin:1rem 0;">
                <h2>Key financials</h2>
                {% if finance %}
                <div class="stats-grid">
                    <div class="stat"><div class="label">Market Cap</div><div class="value">{% if finance.market_cap is not none %}{{ finance.market_cap|humanize }}{% else %}—{% endif %}</div></div>
                    <div class="stat"><div class="label">P/E</div><div class="value">{{ finance.pe_ratio if finance.pe_ratio is not none else '—' }}</div></div>
                    <div class="stat"><div class="label">Revenue</div><div class="value">{% if finance.revenue is not none %}{{ finance.revenue|humanize }}{% else %}—{% endif %}</div></div>
                    <div class="stat"><div class="label">Employees</div><div class="value">{{ finance.employees if finance.employees is not none else '—' }}</div></div>
                </div>
                {% else %}
                <p>No financial data available yet.</p>
                {% endif %}
            </section>

            <section class="card" style="margin:1rem 0;">
                <h2>Stock price (last 3 months)</h2>
                <div class="chart-wrap">
                    <canvas id="priceChart" height="120"></canvas>
                </div>
                <div class="text-muted" id="chartFallback" style="display:none;">No chart data available.</div>
            </section>
            <section class="card" style="margin:1rem 0;">
                <h2>Set ticker manually</h2>
                <p class="text-muted">If automatic lookup can’t find data, specify the exchange symbol (e.g., AAPL, MSFT, GOOGL).</p>
                <form method="post" action="{{ url_for('main.set_company_ticker', company_id=company.id) }}">
                    {{ ticker_form.hidden_tag() }}
                    <div class="field" style="display:flex; gap:.5rem; align-items:center;">
                        {{ ticker_form.ticker(class_='input', placeholder='AAPL') }}
                        <button class="btn" type="submit">{{ ticker_form.submit.label.text }}</button>
                    </div>
                </form>
            </section>
            <section>
                <h2>Traction signals</h2>
                <ul>
                    <li>Growth signals (demo)</li>
                    <li>News (demo)</li>
                    <li>Recent developments (demo)</li>
                </ul>
            </section>
            <section>
                <h2>Similar companies</h2>
                <p>Automatic competitor detection (demo).</p>
            </section>
        <div class="actions">
            <a href="{{ url_for('main.index') }}" class="btn">Back to Home</a>
            <a href="{{ url_for('main.compare') }}" class="btn">Compare</a>
        </div>
    </div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    (async function(){
        try{
            const res = await fetch("{{ url_for('main.company_price_history', company_id=company.id) }}", { cache: "no-store" });
            const data = await res.json();
            const labels = data.labels || [];
            const prices = data.prices || [];
            if(!labels.length || !prices.length){
                document.getElementById('chartFallback').style.display = 'block';
                return;
            }
            const ctx = document.getElementById('priceChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: (data.ticker || 'Price'),
                        data: prices,
                        borderColor: '#8fb3ff',
                        backgroundColor: 'rgba(143,179,255,0.15)',
                        tension: 0.25,
                        pointRadius: 0,
                        fill: true,
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.06)' }, ticks: { color: '#9fb3c8' } },
                        y: { grid: { color: 'rgba(255,255,255,0.06)' }, ticks: { color: '#9fb3c8' } }
                    },
                    plugins: { legend: { labels: { color: '#e6edf3' } } }
                }
            });
        }catch(e){
            document.getElementById('chartFallback').style.display = 'block';
        }
    })();
</script>
{% endblock %}